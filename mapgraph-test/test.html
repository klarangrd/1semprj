<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map graph test</title>
    <!-- Include D3.js and Turf.js libraries -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.3.0"></script>
</head>
<body>
    <h1>Map of the Caribbean</h1>

    <label for="chosenYear">Choose Year:</label>
    <select id="chosenYear"></select>

    <button onclick="selectedYear()">Search</button>
    <button onclick="zoominout(true)">+</button>
    <button onclick="zoominout(false)">-</button>

    <script>
        const w = 1000; // width
        const h = 500;  // height

        let zoom = 1400;

        const svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .style("background-color", "lightblue");

        function populateDropdown(years) {
            const dropdown = d3.select("#chosenYear");

            dropdown.selectAll("option")
                .data(years)
                .enter()
                .append("option")
                .text(d => d)
                .attr("value", d => d);
        }

        function selectedYear() {
            const selectedYear = d3.select("#chosenYear").property("value");

            console.log("Selected Year:", selectedYear);
        }

        Promise.all([
            d3.json("c2.json"),  // Assuming this is your GeoJSON file
            d3.json("http://localhost:3000/kordinater")  // Load external JSON file for bubble data
        ]).then(function (data) {
            const geojson = data[0];
            const bubbleData = data[1].LionfishCloud;

            parseData(bubbleData);
            console.log(bubbleData);

            const projection = d3.geoMercator()
                .center([-75, 18])
                .scale(zoom)
                .translate([w / 2, h / 2]);

            const path = d3.geoPath().projection(projection);

            svg.selectAll("path")
                .data(geojson.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill", "green");

            // Bubble dataset
            svg.selectAll("circle")
                .data(bubbleData)
                .enter()
                .append("circle")
                .attr("cx", d => projection([d.longitude, d.latitude])[0])
                .attr("cy", d => projection([d.longitude, d.latitude])[1])
                .attr("r", 4)
                .style("fill", "red")
                .style("opacity", 0.5)  // Adjust the opacity value as needed
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut);

            // Extract unique years from the dataset
            const uniqueYears = Array.from(new Set(bubbleData.map(d => d.year)));

            // Populate dropdown with unique years
            populateDropdown(uniqueYears);
            
            function handleMouseOver(d) {
                svg.append("text")
                    .attr("class", "hover-label")
                    .attr("x", projection([d.longitude, d.latitude])[0])
                    .attr("y", projection([d.longitude, d.latitude])[1] - 10)
                    .text(d.name);
            }

            function handleMouseOut() {
                svg.selectAll(".hover-label").remove();
            }
        });

        function parseData(bubbleData){
            for (const data of bubbleData) {
                data.latitude = parseFloat(data.latitude);
                data.longitude = parseFloat(data.longitude);
            }
        }
    </script>
</body>
</html>
